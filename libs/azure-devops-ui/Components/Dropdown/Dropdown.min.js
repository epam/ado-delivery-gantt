import{__assign,__extends,__spreadArrays}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Dropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import*as Utils_Accessibility from"../../Core/Util/Accessibility";import{format}from"../../Core/Util/String";import{FilteredListSelection,renderListCell}from"../../List";import{getListBoxItemsValue,getUnselectableRanges,ListBoxItemType,wrapListBoxItems}from"../../ListBox";import{ItemsObserver,Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{SimpleTableCell}from"../../Table";import{css}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{getItemsValue}from"../../Utilities/Provider";import{DropdownCallout}from"./DropdownCallout";import{DropdownExpandableTextField}from"./DropdownExpandableTextField";var Dropdown=function(n){function e(e){var R=n.call(this,e)||this,t=(R.expandable=React.createRef(),R.expandableContainer=React.createRef(),R.filterText=new ObservableValue(""),R.collapse=function(){R.expandable.current&&R.expandable.current.collapse()},R.expand=function(){R.expandable.current&&R.expandable.current.expand()},R.onDismiss=function(){R.expandable.current&&R.expandable.current.collapse()},R.onExpand=function(){R.props.onExpand&&R.props.onExpand(),R.updateFilteredItems(),R.state.expanded.value=!0},R.onCollapse=function(){R.props.onCollapse&&R.props.onCollapse(),R.state.expanded.value=!1},R.onActivate=function(e,t){var r;e.defaultPrevented||"keydown"!==e.type||((r=!R.props.enforceSingleSelect&&R.state.filteredSelection.multiSelect)?R.state.filteredSelection.toggle(R.state.filteredItems.value.indexOf(t),R.state.filteredSelection.alwaysMerge,r):R.state.filteredSelection.select(R.state.filteredItems.value.indexOf(t),1,R.state.filteredSelection.alwaysMerge,r),R.onSelect(e,t))},R.onFilterTextChanged=function(e,t){R.filterText.value=t,R.debouncedUpdateFilteredItems()},R.onSelect=function(e,t){var r=R.props,n=r.dismissOnSelect,r=r.onSelect,i=R.parentSelection;r&&r(e,t),(void 0!==n?n:0<i.value.length&&(R.props.enforceSingleSelect||!i.multiSelect)&&!i.selectOnFocus)&&R.onDismiss()},R.selectionChanged=function(e,t){return R.state.filteredSelection.selectionChanged(e,t),!0},R.renderCallout=function(e,t,r,n,i,l,o){var s=R.props,a=s.actions,d=s.calloutContentClassName,p=s.columns,c=s.containerClassName,m=s.filterPlaceholderText,u=s.filteredNoResultsText,f=s.getUnselectableRanges,x=s.items,h=s.loading,I=s.noItemsText,g=s.onToggle,b=s.renderItem,v=s.renderBeforeContent,T=s.searching,y=s.showFilterBox,S=s.showItemsWhileSearching,C=s.showTree,s=s.userFilteredItems,w=R.props.width,L=(void 0===w&&R.expandableContainer.current&&(L=null!=(L=R.props.minCalloutWidth)?L:100,w=Math.max(R.expandableContainer.current.clientWidth,L)),R.state),B=L.filteredItems,F=L.filterText,a={actions:a,anchorElement:r,anchorOffset:n,anchorOrigin:i,anchorPoint:l,calloutContentClassName:d,columns:p,containerClassName:c,dropdownOrigin:o,filteredItems:B,filteredNoResultsText:u,selection:L.filteredSelection,filterPlaceholderText:m,filterText:F,getUnselectableRanges:f,id:t,items:x,loading:h,noItemsText:I,onActivate:R.onActivate,onFilterTextChanged:R.onFilterTextChanged,onDismiss:R.onDismiss,onSelect:R.onSelect,onToggle:g,renderBeforeContent:v,renderItem:b,searching:T,showItemsWhileSearching:S,showFilterBox:y,showTree:C,updateFilteredItems:R.updateFilteredItems,userFilteredItems:s,width:w};return R.props.renderCallout(a)},R.updateFilteredItems=function(){return updateFilteredItems(R.props,R.state),!0},R.debouncedUpdateFilteredItems=function(){updateFilteredItems(R.props,R.state)},R.parentSelection=e.selection||new DropdownSelection,wrapListBoxItems(e.items)),r=getListBoxItemsValue(t||e.items);return R.timerManagement=new TimerManagement,R.state={expanded:new ObservableValue(!1),filteredItems:new ObservableArray(__spreadArrays(r)),filteredSelection:new FilteredListSelection(R.parentSelection),filterText:R.filterText,props:e,wrappedItems:t},R}return __extends(e,n),e.getDerivedStateFromProps=function(e,t){return e.userFilteredItems===t.props.userFilteredItems&&e.items===t.props.items||updateFilteredItems(e,t),__assign(__assign({},t),{props:e,wrappedItems:wrapListBoxItems(e.items)})},e.prototype.componentDidMount=function(){this.props.filterThrottleWait&&(this.debouncedUpdateFilteredItems=this.timerManagement.debounce(this.debouncedUpdateFilteredItems,this.props.filterThrottleWait))},e.prototype.render=function(){var e=this,t=this.props,r=t.ariaLabel,n=t.ariaLabelledBy,i=t.autoSelect,l=t.className,o=t.disabled,s=t.enforceSingleSelect,a=t.excludeTabStop,d=t.inputId,p=t.items,c=t.placeholder,m=t.renderExpandable,u=t.renderSelectedItems,f=t.showPrefix,x=t.required,t={observableValue:this.parentSelection,filter:this.selectionChanged};return React.createElement(ItemsObserver,{getUnselectableRanges:this.props.getUnselectableRanges,items:p,selection:this.parentSelection},React.createElement(Observer,{selection:t},function(){return m({ariaLabel:r,ariaLabelledBy:n,autoSelect:i,className:css(l,"bolt-dropdown-expandable"),containerRef:e.expandableContainer,disabled:o,enforceSingleSelect:s,excludeTabStop:a,inputId:d,placeholder:c,onCollapse:e.onCollapse,onExpand:e.onExpand,expandableRef:e.expandable,renderCallout:e.renderCallout,items:getListBoxItemsValue(e.state.wrappedItems||p),renderSelectedItems:u,selection:e.parentSelection,showPrefix:f,required:x})}))},e.prototype.focus=function(){this.expandable.current&&this.expandable.current.focus()},e.defaultProps={filterByText:!0,filterItem:filterItemByText,getUnselectableRanges:getUnselectableRanges,renderCallout:DropdownCallout,renderExpandable:DropdownExpandableTextField,renderSelectedItems:renderDropdownSelectedItemText},e}(React.Component);function filterItemByText(e,t){return!(!t.text||t.type===ListBoxItemType.Header||t.type===ListBoxItemType.Divider||t.type===ListBoxItemType.Loading)&&-1!==t.text.toLowerCase().indexOf(e.toLowerCase())}function renderDropdownSelectedItemText(e,t){t=t[e.value[0].beginIndex],t=t&&t.text||"";return t=1<e.selectedCount?t+" (+"+(e.selectedCount-1)+")":t}function updateFilteredItems(e,t){var r=t.filteredSelection,n=t.filterText,i=[],l=getListBoxItemsValue(t.wrappedItems||e.items),o=l;if(e.userFilteredItems){var o=getItemsValue(e.userFilteredItems),s=e.userFilteredItemsIndexMap&&e.userFilteredItemsIndexMap.value;if(s)i=s;else for(var a=0;a<e.userFilteredItems.length;a++)!function(t){var e=l.findIndex(function(e){return e.id===o[t].id});i.push(e)}(a)}for(e.filterByText&&n.value&&(s=filterItems(o,n.value,i,e.filterItem),o=s.filteredItems,i=s.filteredIndexMap);o.length&&o[0].type===ListBoxItemType.Divider;)o.shift(),i.shift();return ObservableLike.getValue(e.searching)||ObservableLike.getValue(e.loading)||!t.expanded.value||(n.value?(s=Resources.NoFilterResults,e.filteredNoResultsText&&(s=ObservableLike.getValue(e.filteredNoResultsText)),Utils_Accessibility.announce(0<o.length?format(Resources.AnnounceFilterResultCount,o.length):s,!0)):0===o.length&&e.noItemsText?Utils_Accessibility.announce(e.noItemsText,!0):0<o.length&&Utils_Accessibility.announce(format(Resources.AnnounceItemCount,o.length))),r.updateFilteredSelection(i,!e.enforceSingleSelect&&void 0),t.filteredItems.value=o,!0}function filterItems(e,t,r,n){void 0===r&&(r=[]),void 0===n&&(n=filterItemByText);var i=[],l=[],o=[];if(t)for(var s=void 0,a=-1,d=void 0,p=-1,c=0,m=e.length;c<m;c++){var u,f=e[c],x=r.length?r[c]:c;f.type===ListBoxItemType.Header?(s=f,a=x):f.type===ListBoxItemType.Divider?(d=f,p=x):!(u=n(t,f,e))&&f.type!==ListBoxItemType.Loading||(d&&d.groupId===f.groupId&&(i.push(d),l.push(p),d=void 0),s&&s.groupId===f.groupId&&(i.push(s),l.push(a),s=void 0),i.push(f),l.push(x),o.push(Array.isArray(u)?u:[]))}return{filteredItems:i,filteredIndexMap:l,filterMatches:o}}function filterTreeItems(e,t,r,n,i){void 0===i&&(i=filterMatchedItemByListboxType);for(var t=filterItems(e,t,r=void 0===r?[]:r,n=void 0===n?filterItemByText:n),r=t.filteredIndexMap,n=t.filteredItems.find(i),l={},o=0,s=r;o<s.length;o++){for(var a=e[f=s[o]],d=a.parent;d;)(l[e.indexOf(d)]=d).expanded=!0,d=d.parent;l[f]=a}for(var p=[],c=[],m=0,u=Object.keys(l);m<u.length;m++){var f,x=u[m],x=l[f=Number(x)];p.push(f),c.push(x)}return[{filteredIndexMap:p,filteredItems:c,filterMatches:[]},n?e.indexOf(n):-1]}function filterMatchedItemByListboxType(e){return!e.type||e.type===ListBoxItemType.Row}function renderHighlightedText(e,t,r,n,i){var l=n;return i&&n.text&&(l=__assign(__assign({},n),{textNode:getHighlightedText(n.text,i)})),React.createElement(SimpleTableCell,{className:css(r.className,n.className,n.type===ListBoxItemType.Header&&"bolt-list-box-header"),columnIndex:t,key:t,tableColumn:r},React.createElement("div",{id:n.type===ListBoxItemType.Header?"header-"+n.id:void 0,"aria-label":n.type===ListBoxItemType.Header?format(Resources.HeaderAriaLabel,n.text):void 0},renderListCell(l)))}function getHighlightedText(e,t,r){for(var n=[],i=-1,l=0;l<e.length;l++)-1!==t.indexOf(l)?n&&n[n.length-1]&&n[n.length-1].bold?n[i].text+=e.charAt(l):n[++i]={text:e.charAt(l),bold:!0}:n&&n[n.length-1]&&!n[n.length-1].bold?n[i].text+=e.charAt(l):n[++i]={text:e.charAt(l),bold:!1};for(var o=[],l=0;l<n.length;l++){var s=n[l];s.bold?o.push(React.createElement("span",{className:"font-weight-heavy",key:e+"-"+l},s.text)):o.push(s.text)}return React.createElement("span",{className:r},o)}export{Dropdown,filterItemByText,renderDropdownSelectedItemText,filterItems,filterTreeItems,filterMatchedItemByListboxType,renderHighlightedText,getHighlightedText};