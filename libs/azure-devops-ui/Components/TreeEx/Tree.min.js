import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Tree.css";import"./TreeExpand.css";import*as React from"react";import{ObservableLike}from"../../Core/Observable";import{FocusWithin}from"../../FocusWithin";import{FocusZone,FocusZoneContext,FocusZoneDirection,FocusZoneKeyStroke}from"../../FocusZone";import{getDefaultAnchorProps}from"../../Link";import{renderListCell}from"../../List";import{UncheckedObserver}from"../../Observer";import{renderColumns,renderLoadingCell,SimpleTableCell,Table}from"../../Table";import{css,getSafeId,KeyCode,preventDefault}from"../../Util";import{getTabIndex}from"../../Utilities/Focus";import{TreeExpand}from"./TreeExpand";var Tree=function(e){function t(){var l=null!==e&&e.apply(this,arguments)||this;return l.table=React.createRef(),l.onActivateExpand=function(e,t){!e.defaultPrevented&&t.data.underlyingItem.childItems&&(l.props.onToggle&&l.props.onToggle(e,t.data),e.preventDefault())},l.renderRow=function(r,n,o){return o.singleClickActivation=l.props.onActivate&&o.singleClickActivation,l.props.columns.length<=1&&!o.role&&(o.role="treeitem"),React.createElement(UncheckedObserver,{data:n.underlyingItem.data,key:n.underlyingItem.id},function(e){var t;return e.data?(n.onToggle=n.underlyingItem.childItems?l.props.onToggle:void 0,(t=n.underlyingItem.data.renderRow||l.props.renderRow)?t(r,n,o):renderTreeRow(r,n,o,l.props.columns,e.data)):(t=l.props.renderLoadingRow)?t(r,o):React.createElement(TreeRow,{index:r,details:o},l.props.columns.map(function(e,t){var r=renderLoadingCell(e.columnLayout);return e.hierarchical&&(r=React.createElement(TreeExpand,{depth:o.data.depth},r)),SimpleTableCell({className:"bolt-tree-cell",columnIndex:t,children:r})}))})},l}return __extends(t,e),t.prototype.render=function(){var e=this.props.role,e=void 0===e?1<this.props.columns.length?"treegrid":"tree":e,t=this.props.onActivate||(this.props.onToggle?this.onActivateExpand:void 0);return React.createElement(Table,{ariaLabel:this.props.ariaLabel,behaviors:this.props.behaviors,className:this.props.className,columns:this.props.columns,containerClassName:this.props.containerClassName,eventDispatch:this.props.eventDispatch,focuszoneProps:this.props.focuszoneProps,id:this.props.id,itemProvider:this.props.itemProvider,maxHeight:this.props.maxHeight,onActivate:t,onFocus:this.props.onFocus,onSelect:this.props.onSelect,pageSize:this.props.pageSize,renderHeader:this.props.renderHeader,renderRow:this.renderRow,renderSpacer:this.props.renderSpacer,role:e,rowHeight:this.props.rowHeight,ref:this.table,scrollable:this.props.scrollable,selectableText:this.props.selectableText,selection:this.props.selection,singleClickActivation:this.props.singleClickActivation,showHeader:this.props.showHeader,showLines:this.props.showLines,showScroll:this.props.showScroll,tableBreakpoints:this.props.tableBreakpoints,virtualize:this.props.virtualize})},t.prototype.addOverlay=function(e,t,r,n){if(void 0===n&&(n=0),this.table.current)return this.table.current.addOverlay(e,t,r,n)},t.prototype.removeOverlay=function(e){if(this.table.current)return this.table.current.removeOverlay(e)},t.prototype.focusRow=function(e,t){return void 0===t&&(t=1),this.table.current?this.table.current.focusRow(e,t):Promise.resolve()},t.prototype.getFocusIndex=function(){return this.table.current?this.table.current.getFocusIndex():-1},t.prototype.getStats=function(){return this.table.current?this.table.current.getStats():{firstMaterialized:-1,firstRendered:-1,lastMaterialized:-1,lastRendered:-1}},t.prototype.scrollIntoView=function(e,t){if(this.table.current)return this.table.current.scrollIntoView(e,t)},t}(React.Component),TreeRow=function(e){function t(){var s=null!==e&&e.apply(this,arguments)||this;return s.rowElement=React.createRef(),s.onFocus=function(e){s.props.details.onFocusItem(s.props.index,e)},s.onKeyDown=function(e){var t,r;e.defaultPrevented||s.rowElement.current===e.nativeEvent.srcElement&&(t=s.props.details.data)&&t.onToggle&&(r=t.underlyingItem.expanded,e.which===KeyCode.rightArrow&&!r||e.which===KeyCode.leftArrow&&r)&&(t.onToggle(e,t),e.preventDefault())},s.onPostprocessKeyStroke=function(e){var t;if(!e.defaultPrevented&&e.which===KeyCode.leftArrow){var r=s.rowElement.current;if(e.nativeEvent.srcElement!==r)null!=r&&r.focus();else{var n=s.props.details.data;if(n&&n.parentItem){for(var o=null==r?void 0:r.previousElementSibling,l=null==r?void 0:r.getAttribute("aria-level"),a=null==o?void 0:o.getAttribute("aria-level");o&&r&&l&&a;){var i=Number.parseInt(l);if(Number.parseInt(a)<i)break;o=o.previousElementSibling}n.parentItem.onToggle&&null!=o&&o.id&&(null!=(t=document.getElementById(o.id))&&t.focus(),n.parentItem.onToggle(e,n.parentItem)),e.preventDefault()}}}return FocusZoneKeyStroke.IgnoreNone},s}return __extends(t,e),t.prototype.render=function(){var r=this,e=this.props,n=e.details,o=e.index,l=e.linkProps,a=n.ariaRowOffset,i=n.data,s=n.excludeFocusZone,c=n.renderSpacer,p=n.selectableText,d=n.selection,u=n.singleClickActivation,m=l?"a":"tr",h=getDefaultAnchorProps(l);return React.createElement(FocusWithin,{onFocus:this.onFocus},function(t){return React.createElement(FocusZoneContext.Consumer,null,function(e){return React.createElement(FocusZone,{direction:FocusZoneDirection.Horizontal,postprocessKeyStroke:r.onPostprocessKeyStroke},React.createElement(m,__assign({},h,{"aria-busy":void 0===i,"aria-expanded":i&&i.underlyingItem.childItems?void 0!==i.underlyingItem.expanded&&i.underlyingItem.expanded:void 0,"aria-level":i?i.depth+1:void 0,"aria-rowindex":o+a,"aria-selected":!(!d||!d.selected(o))||void 0,className:css(r.props.className,"bolt-tree-row bolt-table-row bolt-list-row",0===o&&"first-row",t.hasFocus&&"focused",d&&d.selected(o)&&"selected",u&&"single-click-activation",p&&"selectable-text",l&&"v-align-middle"),"data-focuszone":s||d&&!d.selectable(o)?void 0:e.focuszoneId,"data-row-index":o,id:getSafeId(null!=(e=n.data.underlyingItem.id)?e:o.toString()),onBlur:t.onBlur,onFocus:t.onFocus,onKeyDown:r.onKeyDown,ref:r.rowElement,role:n.role||"row",tabIndex:getTabIndex(n)}),React.createElement("td",{key:"left-spacer",className:"bolt-table-cell-compact bolt-table-cell bolt-list-cell",role:"presentation"},c&&c(o,!0)),r.props.children,React.createElement("td",{key:"right-spacer",className:"bolt-table-cell-compact bolt-table-cell bolt-list-cell",role:"presentation"},c&&c(o,!1))))})})},t}(React.Component);function renderTreeRow(e,t,r,n,o,l,a){return React.createElement(TreeRow,{index:e,details:r,linkProps:o?o.linkProps:void 0,className:l,key:a},renderColumns(e,n,t,r))}function ExpandableTreeCell(e){var t=e.colspan,r=e.columnIndex,n=e.contentClassName,o=e.treeItem,l=e.treeColumn,a=o.depth,i=o.onToggle,s=o.underlyingItem.expanded,s=React.createElement(TreeExpand,{expanded:s,depth:a,indentationSize:l&&l.indentationSize,onClick:preventDefault,onToggle:i?function(e){return i(e,o)}:void 0},e.children);return SimpleTableCell({children:s,className:css(e.className,"bolt-tree-cell"),colspan:t,columnIndex:r,contentClassName:n,tableColumn:l})}function renderExpandableTreeCell(e,t,r,n){var o=n.underlyingItem,o=ObservableLike.getValue(o.data),o=o&&o[r.id],l=!(!o||"string"==typeof o||"number"==typeof o||!o.href);return ExpandableTreeCell({children:o&&renderListCell(o),className:r.className,columnIndex:t,contentClassName:l?"bolt-table-cell-content-with-link":void 0,treeItem:n,treeColumn:r})}function renderTreeCell(e,t,r,n){var n=n.underlyingItem,n=ObservableLike.getValue(n.data),n=n&&n[r.id],o=!(!n||"string"==typeof n||"number"==typeof n||!n.href);return SimpleTableCell({className:r.className,children:n&&renderListCell(n),columnIndex:t,contentClassName:o?"bolt-table-cell-content-with-link":void 0,tableColumn:r})}function renderTreeCellWithClassName(e,t,r,n,o){var n=n.underlyingItem,n=ObservableLike.getValue(n.data),n=n&&n[r.id],l=!(!n||"string"==typeof n||"number"==typeof n||!n.href);return SimpleTableCell({className:r.className,children:n&&renderListCell(n),columnIndex:t,contentClassName:css(o,l?"bolt-table-cell-content-with-link":void 0),tableColumn:r})}export{Tree,TreeRow,renderTreeRow,ExpandableTreeCell,renderExpandableTreeCell,renderTreeCell,renderTreeCellWithClassName};