import{__extends,__spreadArrays}from"tslib";import*as React from"react";var ObservableLike,Observable=function(){function e(){this.observers={},this.subscriberCount=0}return e.prototype.notify=function(e,t,r){function s(e,t,r){try{e(t,r)}catch(e){console.warn(e),e&&"function"==typeof ErrorEvent&&window.dispatchEvent(new ErrorEvent("error",{error:e,filename:"Observable.ts",message:e.message}))}}if(this.observers[t])for(var n=this.observers[t].slice(),i=0;i<n.length;i++)s(n[i],e,t);if(this.observers[""])for(n=this.observers[""].slice(),i=0;i<n.length;i++)s(n[i],e,t);r&&(this.events||(this.events=[]),this.events.push({action:t,value:e}))},e.prototype.subscribe=function(e,t){if(this.observers[t=t||""]||(this.observers[t]=[]),this.observers[t].push(e),this.subscriberCount++,this.events)for(var r=0,s=this.events;r<s.length;r++){var n=s[r];t&&n.action!==t||e(n.value,n.action)}return e},e.prototype.unsubscribe=function(e,t){this.observers[t=t||""]&&0<=(e=this.observers[t].indexOf(e))&&(this.observers[t].splice(e,1),this.subscriberCount--)},e}(),ObservableValue=(!function(e){function s(e){return e&&"function"==typeof e.subscribe}e.isObservable=s,e.getValue=function(e){return s(e)?e.value:e},e.subscribe=function(e,t,r){return s(e)?e.subscribe(t,r):function(){}},e.unsubscribe=function(e,t,r){s(e)&&e.unsubscribe(t,r)}}(ObservableLike=ObservableLike||{}),function(r){function e(e){var t=r.call(this)||this;return t.v=e,t}return __extends(e,r),Object.defineProperty(e.prototype,"value",{get:function(){return this.v},set:function(e){this.v=e,this.notify(this.v,"set")},enumerable:!1,configurable:!0}),e}(Observable)),ObservableObject=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.objects={},e}return __extends(e,t),e.prototype.add=function(e,t){this.objects.hasOwnProperty(e)||(this.objects[e]=t,this.notify({key:e,value:t},"add"))},e.prototype.get=function(e){return this.objects[e]},e.prototype.set=function(e,t){this.objects.hasOwnProperty(e)?(this.objects[e]=t,this.notify({key:e,value:t},"replace")):this.add(e,t)},e.prototype.keys=function(){return Object.keys(this.objects)},e}(Observable),ObservableArray=function(r){function e(e){void 0===e&&(e=[]);var t=r.call(this)||this;return t.internalItems=e||[],t}return __extends(e,r),e.prototype.change=function(e){for(var t,r=[],s=1;s<arguments.length;s++)r[s-1]=arguments[s];return(t=this.internalItems).splice.apply(t,__spreadArrays([e,r.length],r)),this.notify({index:e,changedItems:r},"change"),r.length},Object.defineProperty(e.prototype,"length",{get:function(){return this.internalItems.length},enumerable:!1,configurable:!0}),e.prototype.push=function(){for(var e,t,r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];return r.length&&(t=this.internalItems.length,(e=this.internalItems).push.apply(e,r),this.notify({addedItems:r,index:t},"push")),r.length},e.prototype.pop=function(){var e=this.internalItems.pop();return void 0!==e&&this.notify({index:this.internalItems.length,removedItems:[e]},"pop"),e},e.prototype.removeAll=function(e){for(var t=[],r=[],s=0,n=this.internalItems;s<n.length;s++){var i=n[s];(!e||e(i)?t:r).push(i)}if(0<t.length){this.internalItems.splice(0,this.internalItems.length);for(var o=0,u=r;o<u.length;o++){i=u[o];this.internalItems.push(i)}this.notify({index:0,removedItems:t},"removeAll")}return t},e.prototype.splice=function(e,t){for(var r=[],s=2;s<arguments.length;s++)r[s-2]=arguments[s];var n=(n=this.internalItems).splice.apply(n,__spreadArrays([e,t],r));return this.notify({addedItems:r,index:e,removedItems:n},"splice"),n},Object.defineProperty(e.prototype,"value",{get:function(){return this.internalItems},set:function(e){var t;if(e===this.internalItems)t=this.internalItems;else if(t=this.internalItems.slice(),this.internalItems.length=0,e.length)for(var r=0,s=e;r<s.length;r++){var n=s[r];this.internalItems.push(n)}this.notify({addedItems:e,index:0,removedItems:t},"splice")},enumerable:!1,configurable:!0}),e}(Observable),ObservableCollection=function(i){function e(){var e=null!==i&&i.apply(this,arguments)||this;return e.collections=[],e.items=[],e}return __extends(e,i),Object.defineProperty(e.prototype,"length",{get:function(){return this.subscriberCount||this.recalculateItems(),this.items.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this.subscriberCount||this.recalculateItems(),this.items},enumerable:!1,configurable:!0}),e.prototype.push=function(e,t){var r,s;if(ObservableLike.isObservable(e)?(r={observable:s=e,subscriber:n=this.getSubscriber(this.collections.length,t),transformItems:t,items:[]},s=s.value,this.subscriberCount&&ObservableLike.subscribe(r.observable,n)):e.length&&(r={items:this.transformItems(s=e,t)}),r&&(this.collections.push(r),this.subscriberCount)&&s.length){for(var n=this.transformItems(s,t),i=0,o=n;i<o.length;i++){var u=o[i];this.items.push(u)}this.notify({addedItems:n,index:this.items.length-n.length},"push")}},e.prototype.subscribe=function(e,t){e=i.prototype.subscribe.call(this,e,t);if(1===this.subscriberCount){this.recalculateItems();for(var r=0,s=this.collections;r<s.length;r++){var n=s[r];n.subscriber&&n.observable.subscribe(n.subscriber)}}return e},e.prototype.unsubscribe=function(e,t){if(i.prototype.unsubscribe.call(this,e,t),0===this.subscriberCount)for(var r=0,s=this.collections;r<s.length;r++){var n=s[r];n.subscriber&&n.observable.unsubscribe(n.subscriber)}},e.prototype.recalculateItems=function(){for(var e=this.items.length=0,t=this.collections;e<t.length;e++){var r=t[e];r.observable&&(r.items=this.transformItems(r.observable.value,r.transformItems));for(var s=0,n=r.items;s<n.length;s++){var i=n[s];this.items.push(i)}}},e.prototype.transformItems=function(e,t){if(e)if(t)for(var r=[],s=0,n=e;s<n.length;s++){var i=t(n[s]);void 0!==i&&r.push(i)}else r=e;else r=[];return r},e.prototype.getSubscriber=function(c,b){var h=this;return function(e){for(var t=e.index,r=0;r<c;r++)t+=h.collections[r].items.length;if(e.changedItems){var s=h.transformItems(e.changedItems,b);(n=h.items).splice.apply(n,__spreadArrays([t,e.changedItems.length],s)),h.notify({changedItems:s,index:t},"change")}else{for(var n=h.transformItems(e.removedItems,b),s=h.transformItems(e.addedItems,b),e=(h.items.splice(t,n.length),h.items.splice(t)),i=0,o=s;i<o.length;i++){var u=o[i];h.items.push(u)}for(var a=0,l=e;a<l.length;a++){u=l[a];h.items.push(u)}h.notify({removedItems:n,addedItems:s,index:t},"splice")}}},e}(Observable),ReadyableObservableArray=function(r){function e(e,t){void 0===t&&(t=!1);e=r.call(this,e=void 0===e?[]:e)||this;return e.ready=new ObservableValue(t),e}return __extends(e,r),e}(ObservableArray);function useObservable(e){var t=React.useState(e)[0],r=React.useState(function(){return new ObservableValue(t)})[0];return[r,function(e){r.value="function"==typeof e?e(r.value):e}]}function useObservableArray(e){var e=React.useState(e)[0],t=React.useState(new ObservableArray(e));return[t[0],function(e){t[0].value="function"==typeof e?e(t[0].value):e}]}function useDerivedObservable(e,t,r){var s=useObservable(t(e.value)),n=s[0],i=s[1],o=React.useCallback(t,r);return useSubscription(e,function(e){e=o(e);i(e)},r),n}function useSubscription(t,e,r){void 0===r&&(r=[]);var s=React.useRef(!1),n=React.useCallback(e,r);React.useEffect(function(){s.current?n(t.value):s.current=!0},[t]),React.useEffect(function(){function e(){return n(t.value)}return t.subscribe(e),function(){return t.unsubscribe(e)}},[t,n])}function useDebouncedSubscription(e,t,r,s){void 0===s&&(s=[]);var n=React.useRef(null);useSubscription(e,function(e){n.current&&clearTimeout(n.current),n.current=setTimeout(function(){r(e),n.current=null},t)},__spreadArrays([t],s))}export{Observable,ObservableLike,ObservableValue,ObservableObject,ObservableArray,ObservableCollection,ReadyableObservableArray,useObservable,useObservableArray,useDerivedObservable,useSubscription,useDebouncedSubscription};